---
title: "integrate spatial transcriptome and Image (pancreatic ductal adenocarcinomas)"
author: "Yu Wang, Shilin Zhao"
date: "08/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message = F, warning = F}
require(tidyverse)
require(Seurat)
require(stImage)

#source("~/source/stImage/LoadImageFeature.R")
#source("~/source/stImage/MultimodalImageWorkflow.R")
dataDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
workDir="/data/cqs/ywang/source/analysis/"
setwd(workDir)

```

## load Image Feature into Seurat object

### PDAC-B

```{r, eval=FALSE}

objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
projDir <- "/scratch/cqs/zhaos/Spatial/data/pancreatic_ductal_adenocarcinomas/"

#setwd(projDir)

positionTableFile="GSM3405534_PDAC-B-ST1-HE.jpg.position.tsv"
countTableFile="GSM3405534_PDAC-B-ST1-filtered.txt.Reformated.tsv"
sampleName="PDAC-B"

countTable=read.delim(paste0(projDir, countTableFile),header=T,row.names=1)
positionTable=read.delim(paste0(projDir, positionTableFile),header=FALSE,row.names=1)
positionTable=positionTable[which(positionTable[,1]==1),]
positionTable=positionTable[,c(4:5)] #only need ImageY and ImageX

imageFeatureFile="PDAC-B-ST1_patch600_features.csv"
imageFeatures=read.csv(imageFeatureFile,header=TRUE,row.names=1)
dataObj=LoadImageFeature(countTable = countTable,
              imageFeatures = imageFeatures, positionTable = positionTable, by_Feature = FALSE, project = sampleName)
saveRDS(dataObj,paste0(objDir,sampleName,".Patch600.SeuratObj.rds"))

imageFeatureFile="PDAC-B-ST1_patch400_features.csv"
imageFeatures=read.csv(paste0(projDir, imageFeatureFile),header=TRUE,row.names=1)
PDAC_B_dataObj=LoadImageFeature(countTable = t(countTable),
              imageFeatures = imageFeatures, positionTable = positionTable, by_Feature = FALSE, project = sampleName)
saveRDS(PDAC_B_dataObj,paste0(workDir,sampleName,".Patch400.SeuratObj.rds"))

imageFeatureFile="PDAC-B-ST1_patch200_features.csv"
imageFeatures=read.csv(imageFeatureFile,header=TRUE,row.names=1)
PDAC_B_dataObj=LoadImageFeature(countTable = countTable,
              imageFeatures = imageFeatures, positionTable = positionTable, by_Feature = FALSE, project = sampleName)
saveRDS(PDAC_B_dataObj,paste0(objDir,sampleName,".Patch200.SeuratObj.rds"))

```

### PDAC-A

```{r, eval=FALSE}

objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"

setwd("/scratch/cqs/zhaos/Spatial/data/pancreatic_ductal_adenocarcinomas/")

positionTableFile="GSM3036911_PDAC-A-ST1-HE.jpg.position.tsv"
countTableFile="GSM3036911_PDAC-A-ST1-filtered.txt.Reformated.tsv"
sampleName="PDAC-A"

countTable=read.delim(countTableFile,header=T,row.names=1)
positionTable=read.delim(positionTableFile,header=FALSE,row.names=1)
positionTable=positionTable[which(positionTable[,1]==1),]
positionTable=positionTable[,c(4:5)] #only need ImageY and ImageX

imageFeatureFile="PDAC-A-ST1_patch400_features.csv"
imageFeatures=read.csv(paste(projDir, imageFeatureFile, sep = "/"),header=TRUE,row.names=1)
PDAC_A_dataObj=LoadImageFeature(countTable = t(countTable),
              imageFeatures = imageFeatures, positionTable = positionTable, by_Feature = FALSE, project = sampleName)
saveRDS(PDAC_A_dataObj,paste0(workDir,sampleName,".Patch400.SeuratObj.rds"))

```


## Data analysis of Spatial matrix and ImageFeature matrix (Updated)

All analysis should be replaced by codes in this section


### Read data

```{r}

objectRdsName="/data/cqs/ywang/source/analysis/PDAC-B.Patch400.SeuratObj.rds"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch200.SeuratObj.rds"
dataObj=readRDS(objectRdsName)

```

### Analysis by pipeline

#### PCA
```{r}
clusterNum=3

#analyzed by PCA
dataObjPCA <-
  MultimodalPreProcess(
    dataObj,
    normalizeMethod = "SCT",
    DimReducMethod = "PCA",
    genePercentCut = 0.3,
    imagePercentCut = 0.3
  )
dataObjPCA = findSNNClusters(
  dataObjPCA,
  reduction = "SCTPCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
dataObjPCA = findSNNClusters(
  dataObjPCA,
  reduction = "ImageFeaturePCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
dataObjPCA = MultiModalIntegrationVisium(
  dataObjPCA,
  MultimodalMethod = "WNN",
  nCluster = clusterNum,
  resolutionMax = 3
)

p4 <- SpatialDimPlot(dataObjPCA, group.by = "SCTPCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
p5 <- SpatialDimPlot(dataObjPCA, group.by = "ImageFeaturePCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
p6 <- SpatialDimPlot(dataObjPCA, group.by="wnn_cluster3", label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)

p4 + p5 + p6


```

#### Normlize gene by image

```{r}


dataObjPCAGeneNormByImage = NormalizeGeneByImage(dataObjPCA,
                                                 assay = "SCT",
                                                 dataSlot = c("data"))
dataObjPCAGeneNormByImage = runDimReduc(dataObjPCAGeneNormByImage, assay =
                                          "SCTNormalizedByImage")
dataObjPCAGeneNormByImage = findSNNClusters(
  dataObjPCAGeneNormByImage,
  reduction = "SCTNormalizedByImagePCA",
  nCluster = clusterNum,
  resolutionMax = 3
)


dataObjPCAGenePCNormByImage = NormalizeGeneByImage(dataObjPCA,
                                                   assay = "SCT",
                                                   geneDimReducName = "SCTPCA")
dataObjPCAGenePCNormByImage = findSNNClusters(
  dataObjPCAGenePCNormByImage,
  reduction = "SCTPCANormalizedByImage",
  nCluster = clusterNum,
  resolutionMax = 3
)

p7 <- SpatialDimPlot(dataObjPCAGeneNormByImage, group.by = "SCTNormalizedByImagePCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()
p8 <- SpatialDimPlot(dataObjPCAGenePCNormByImage, group.by="SCTPCANormalizedByImage_cluster3", label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)
#+ NoLegend()

p7 + p8

```


#### SpatialPCA

```{r}

dataObjSpatialPCA <-
  MultimodalPreProcess(
    dataObj,
    DimReducMethod = "SpatialPCA",
    genePercentCut = 0.05,
    imagePercentCut = 0.05
  )
dataObjSpatialPCA = findSNNClusters(
  dataObjSpatialPCA,
  reduction = "SCTSpatialPCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
dataObjSpatialPCA = findSNNClusters(
  dataObjSpatialPCA,
  reduction = "ImageFeatureSpatialPCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
dataObjSpatialPCA = MultiModalIntegrationVisium(
  dataObjSpatialPCA,
  MultimodalMethod = "WNN",
  reduction.list = list("SCTSpatialPCA", "ImageFeatureSpatialPCA"),
  nCluster = clusterNum,
  resolutionMax = 3
)


p4 <- SpatialDimPlot(dataObjSpatialPCA, group.by = "SCTSpatialPCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
p5 <- SpatialDimPlot(dataObjSpatialPCA, group.by = "ImageFeatureSpatialPCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
p6 <- SpatialDimPlot(dataObjSpatialPCA, group.by="wnn_cluster3", label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)

p4 + p5 + p6


```


#### RGB

```{r}

objectRdsName="/data/cqs/ywang/source/analysis/RGB/PDAC-B.Patch400.RGBquantile.testing.SeuratObj.rds"
dataObj=readRDS(objectRdsName)


dataObjRgb<-
  MultimodalPreProcess(
    dataObj,
    DimReducMethod = "PCA",
    genePercentCut = 0.05,
    imagePercentCut = 0.05
  )
 
dataObjRgb = findSNNClusters(
  dataObjRgb,
  reduction = "SCTPCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
dataObjRgb = findSNNClusters(
  dataObjRgb,
  reduction = "RGBPCA",
  nCluster = clusterNum,
  resolutionMax = 3
)
p1=SpatialDimPlot(dataObjRgb, group.by = "SCTPCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
p2=SpatialDimPlot(dataObjRgb, group.by = "RGBPCA_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 


dataObjRgb = MultiModalIntegrationVisium(
  dataObjRgb,
  MultimodalMethod = "WNN",
  reduction.list = list("SCTPCA", "RGBPCA"),
  nCluster = clusterNum,
  resolutionMax = 3
)
p3=SpatialDimPlot(dataObjRgb, group.by = "wnn_cluster3", label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10)

p1+p2+p3




```































## Data analysis of Spatial matrix and ImageFeature matrix

```{r, eval = F}

#objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch600.SeuratObj.rds"
objectRdsName="/data/cqs/ywang/source/analysis/PDAC-B.Patch400.SeuratObj.rds"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch200.SeuratObj.rds"

PDACB_dataObj=readRDS(objectRdsName)
PDACB_dataObjProcessed <- MultimodalPreProcess(PDACB_dataObj,
                                         normalizeMethod = "SCT",
                                         DimReducMethod = "PCA",
                                         geneResolution=0.9,
                                         imageFeatureResolution = 0.8,
                                         imagePercentCut=0.2)
PDACB_dataObjProcessed <- MultiModalIntegrationVisium(PDACB_dataObjProcessed, 
                                                normalizeMethod = "SCT",
                                                DimReducMethod = "PCA",
                                                imageAndGeneResolution=0.4,
                                                MultimodalMethod = "WNN")
saveRDS(PDACB_dataObjProcessed, paste0(workDir,basename(objectRdsName), ".processed.rds"))

```


```{r, eval = F}

#objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch600.SeuratObj.rds"
objectRdsName="/data/cqs/ywang/source/analysis/PDAC-B.Patch400.SeuratObj.rds"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch200.SeuratObj.rds"

PDACB_dataObj=readRDS(objectRdsName)
PDACB_SPCA_dataObjProcessed <- MultimodalPreProcess(PDACB_dataObj,
                                         normalizeMethod = "SCT",
                                         DimReducMethod = "SpatialPCA",
                                         geneResolution=0.8,
                                         imageFeatureResolution = 0.8,
                                         imagePercentCut=0.2)
PDACB_SPCA_dataObjProcessed <- MultiModalIntegrationVisium(PDACB_SPCA_dataObjProcessed, 
                                                normalizeMethod = "SCT",
                                                DimReducMethod = "SpatialPCA",
                                                imageAndGeneResolution=0.3,
                                                MultimodalMethod = "WNN")
saveRDS(PDACB_SPCA_dataObjProcessed, paste0(workDir,basename(objectRdsName), ".SPCA.processed.rds"))

```


```{r, eval = F}

#objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch600.SeuratObj.rds"
objectRdsName="/data/cqs/ywang/source/analysis/PDAC-A.Patch400.SeuratObj.rds"
#objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch200.SeuratObj.rds"

PDACA_dataObj=readRDS(objectRdsName)
PDACA_dataObjProcessed <- MultimodalPreProcess(PDACA_dataObj,
                                         normalizeMethod = "SCT",
                                         geneResolution=1.4,
                                         imageFeatureResolution = 1.1,
                                         imagePercentCut=0.2)
PDACA_dataObjProcessed <- MultiModalIntegrationVisium(PDACA_dataObjProcessed, 
                                                normalizeMethod = "SCT",
                                                imageAndGeneResolution=1,
                                                MultimodalMethod = "WNN")
saveRDS(PDACA_dataObjProcessed, paste0(workDir,basename(objectRdsName), ".processed.rds"))

```



## plot

```{r}

#workDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
PDACB_objectRdsName="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/PDAC-B.Patch400.SeuratObj.rds"

PDACB_dataObjProcessed <- readRDS(paste0(workDir,basename(PDACB_objectRdsName), ".processed.rds"))

PDACB_SPCA_dataObjProcessed <- readRDS(paste0(workDir,basename(PDACB_objectRdsName), ".SPCA.processed.rds"))

```


### DimPlot

```{r, fig.dim = c(12, 4)}

geneClusterName=grep("SCT_snn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)
imageClusterName=grep("ImageFeature_snn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)
integratedClusterName=grep("wsnn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)

p1 <- DimPlot(PDACB_dataObjProcessed, reduction = 'st.umap', group.by = geneClusterName, label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p2 <- DimPlot(PDACB_dataObjProcessed, reduction = 'if.umap', group.by =imageClusterName, label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p3 <- DimPlot(PDACB_dataObjProcessed, reduction = 'wnn.umap', group.by =integratedClusterName, label = TRUE, repel = TRUE, label.size = 2.5) + NoLegend()

p1 + p2 + p3

```

### SpatialDimPlot

#### PCA

```{r, fig.dim = c(12, 4)}
# geneClusterName=grep("SCT_snn_res",colnames(dataObjProcessed@meta.data),value=TRUE)
# imageClusterName=grep("ImageFeature_snn_res",colnames(dataObjProcessed@meta.data),value=TRUE)
# integratedClusterName=grep("wsnn_res",colnames(dataObjProcessed@meta.data),value=TRUE)


DefaultAssay(PDACB_dataObjProcessed) <- "Spatial"
p4 <- SpatialDimPlot(PDACB_dataObjProcessed, group.by = geneClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

DefaultAssay(PDACB_dataObjProcessed) <- "ImageFeature"
p5 <- SpatialDimPlot(PDACB_dataObjProcessed, group.by = imageClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

p6 <- SpatialDimPlot(PDACB_dataObjProcessed, group.by=integratedClusterName, label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)
#+ NoLegend()

p4 + p5 + p6
#p4+p6

```
#### Spatial PCA

```{r, fig.dim = c(12, 4)}
geneClusterName=grep("st_spca_snn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)
imageClusterName=grep("if_spca_snn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)
integratedClusterName=grep("spca_wsnn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)


DefaultAssay(PDACB_SPCA_dataObjProcessed) <- "Spatial"
p7 <- SpatialDimPlot(PDACB_SPCA_dataObjProcessed, group.by = geneClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

DefaultAssay(PDACB_SPCA_dataObjProcessed) <- "ImageFeature"
p8 <- SpatialDimPlot(PDACB_SPCA_dataObjProcessed, group.by = imageClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

p9 <- SpatialDimPlot(PDACB_SPCA_dataObjProcessed, group.by=integratedClusterName, label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)
#+ NoLegend()

p7 + p8 + p9


```


### Weight of SCT and ImageFeature

#### PCA

```{r, fig.dim = c(8, 4)}
geneClusterName=grep("SCT_snn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)
imageClusterName=grep("ImageFeature_snn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)
integratedClusterName=grep("wsnn_res",colnames(PDACB_dataObjProcessed@meta.data),value=TRUE)

p10 <- VlnPlot(PDACB_dataObjProcessed, features = "SCT.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p11 <- VlnPlot(PDACB_dataObjProcessed, features = "ImageFeature.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p10 + p11

```

#### Spatial PCA


```{r, fig.dim = c(8, 4)}
geneClusterName=grep("st_spca_snn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)
imageClusterName=grep("if_spca_snn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)
integratedClusterName=grep("spca_wsnn_res",colnames(PDACB_SPCA_dataObjProcessed@meta.data),value=TRUE)


p12 <- VlnPlot(PDACB_SPCA_dataObjProcessed, features = "SCT.spca.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p13 <- VlnPlot(PDACB_SPCA_dataObjProcessed, features = "ImageFeature.spca.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p12 + p13

```

