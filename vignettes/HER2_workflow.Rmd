---
title: "integrate spatial transcriptome and Image with stImage (HER2)"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
---

```{r setup, include=FALSE}
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  time_it = TRUE
)
```


# Overview

```{r install, message = F, warning = F, echo = F}
library(tidyverse)
library(Seurat)
library(stImage)
library(patchwork)
library(reticulate)
use_condaenv(condaenv = "myenv", conda = "/home/wangy67/miniconda3/bin/conda")

```


# Prepare input file

```{r define, echo = T, eval = T}
workDir="/data/cqs/ywang/source/analysis/"
setwd(workDir)
tstamp <- gsub("-", "", as.character(Sys.Date()))
coordinateFile="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/her2st/data/ST-spotfiles/H1_selection.tsv"
countTableFile="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/her2st/data/ST-cnts/H1.tsv.gz"
sampleName="HER2.H1"

rawimg <- "/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/her2st/H1_patch200_image.png"
coordinate=read.delim(coordinateFile)
#Again Please note row name (posTable) are X*Y. the format of output(to match with 10X) position file are row(Y) and col(X)
positionTable=coordinate[,c(6,5)]
row.names(positionTable)=paste0("X",coordinate$x,"x",coordinate$y)


countTable=read.delim(countTableFile,header=T,row.names=1)
row.names(countTable)=paste0("X",row.names(countTable))

#patch 200
imageFeatureFile="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/her2st/H1_patch200_features.csv"
imageFeatures=read.csv(imageFeatureFile,header=TRUE,row.names=1)

if (identical(sort(row.names(countTable)),sort(row.names(imageFeatures)))) {
  imageFeatures=imageFeatures[row.names(countTable),]
  positionTable=positionTable[row.names(countTable),]
} else {
  stop("Differenti sample names in countTable and imageFeatures")
}

```


# Extract features

```{r extract.feature, echo = T, eval = F}
#need check the scaleFactor
imageFeatures_raw=extract_features(imgFile = rawimg, positionTable = positionTable, patchSize = 200, rawImage = F, savePatchOnImage = paste0(proj_folder, "_rawpatch", "_", tstamp, ".png"))

#write.csv(imageFeatures_raw,paste0(workDir,"/",proj_folder,"_features_raw_",tstamp,".csv"))

```


# load Image Feature into Seurat object


```{r, eval = F}
dataObj=LoadImageFeature(countTable = t(countTable),
              imageFeatures = imageFeatures, positionTable = positionTable, project = sampleName)
saveRDS(dataObj,paste0(workDir,sampleName,".Patch200.SeuratObj.rds"))

```


# Data analysis of Spatial matrix and ImageFeature matrix

```{r, eval = F}

#objDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"

objectRdsName=paste0(workDir,"HER2.H1.Patch200.SeuratObj.rds")

dataObj=readRDS(objectRdsName)
dataObjProcessed <- MultimodalPreProcess(dataObj,
                                         normalizeMethod = "SCT",
                                         geneResolution=1.4,
                                         imageFeatureResolution = 1.1,
                                         imagePercentCut=0.1)
dataObjProcessed <- MultiModalIntegrationVisium(dataObjProcessed,
                                                normalizeMethod = "SCT",
                                                imageAndGeneResolution=1,
                                                MultimodalMethod = "WNN")
saveRDS(dataObjProcessed, paste0(workDir,basename(objectRdsName), ".processed.rds"))

```



# plot

```{r}

#workDir="/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/objRds/"
objectRdsName="HER2.H1.Patch200.SeuratObj.rds"

dataObjProcessed <- readRDS(paste0(workDir,basename(objectRdsName), ".processed.rds"))
# 
```


## DimPlot

```{r, fig.dim = c(12, 4)}

geneClusterName=grep("SCT_snn_res",colnames(dataObjProcessed@meta.data),value=TRUE)
imageClusterName=grep("ImageFeature_snn_res",colnames(dataObjProcessed@meta.data),value=TRUE)
integratedClusterName=grep("wsnn_res",colnames(dataObjProcessed@meta.data),value=TRUE)

p1 <- DimPlot(dataObjProcessed, reduction = 'st.umap', group.by = geneClusterName, label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p2 <- DimPlot(dataObjProcessed, reduction = 'if.umap', group.by =imageClusterName, label = TRUE, 
              repel = TRUE, label.size = 2.5) + NoLegend()
p3 <- DimPlot(dataObjProcessed, reduction = 'wnn.umap', group.by =integratedClusterName, label = TRUE, repel = TRUE, label.size = 2.5) + NoLegend()

p1 + p2 + p3

```

### SpatialDimPlot

```{r, fig.dim = c(12, 4)}

DefaultAssay(dataObjProcessed) <- "Spatial"
p4 <- SpatialDimPlot(dataObjProcessed, group.by = geneClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

DefaultAssay(dataObjProcessed) <- "ImageFeature"
p5 <- SpatialDimPlot(dataObjProcessed, group.by = imageClusterName, label = TRUE, label.box = F, label.size = 2,pt.size.factor = 10) 
#+ NoLegend()

p6 <- SpatialDimPlot(dataObjProcessed, group.by=integratedClusterName, label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10)
#+ NoLegend()

p4 + p5 + p6
#p4+p6

```

### Weight of SCT and ImageFeature

```{r, fig.dim = c(8, 4)}

p7 <- VlnPlot(dataObjProcessed, features = "SCT.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p8 <- VlnPlot(dataObjProcessed, features = "ImageFeature.weight", group.by = integratedClusterName, sort = TRUE, pt.size = 0.1) +
  NoLegend()
p7 + p8

```

### ARI with pathologist review region

```{r}
library(clues)
#pathologist review region
reviewRegions=read.delim("/scratch/cqs/zhaos/Spatial/SpatialTranscriptomicsImage/her2st/data/ST-pat/lbl/H1_labeled_coordinates.tsv")
temp1=order(dataObjProcessed@images$images@coordinates$pixel_y,dataObjProcessed@images$images@coordinates$pixel_x)
#head(positionTable[temp1,])
temp2=order(reviewRegions$y,reviewRegions$x)
#head(reviewRegions[temp2,])
dataObjProcessed@meta.data$TrueLabel=NA
dataObjProcessed@meta.data$TrueLabel[temp1]=reviewRegions$label[temp2]
#visulization of review regions
SpatialDimPlot(dataObjProcessed, group.by = "TrueLabel", label = TRUE, label.box = F, repel = TRUE, label.size = 2,pt.size.factor = 10) 
p6
predictedCluster=as.character(dataObjProcessed@meta.data$"wsnn_res.1")
table(dataObjProcessed@meta.data$"wsnn_res.1",dataObjProcessed@meta.data$TrueLabel)
table(predictedCluster,dataObjProcessed@meta.data$TrueLabel)
predictedCluster[predictedCluster==0]="adipose tissue"
predictedCluster[predictedCluster==1]="connective tissue"
predictedCluster[predictedCluster==2]="connective tissue"
predictedCluster[predictedCluster==3]="cancer in situ"
predictedCluster[predictedCluster==4]="invasive cancer"
predictedCluster[predictedCluster==5]="immune infiltrate"
predictedCluster[predictedCluster==6]="breast glands"
trueLabel=dataObjProcessed@meta.data$TrueLabel
naInd=which(trueLabel=="undetermined")
    adjustedRand(
      as.integer(as.factor(predictedCluster[-naInd])),
      as.integer(as.factor(trueLabel[-naInd])),
      randMethod="HA"
    )
#0.5768265  
```


```{r, eval = F}
    
library(nnet)
library(DescTools)
PseudoR2Result=NULL 
for (i in c(1:20)) {
  #fit mutinorm regression model to get PseudoR2
temp=cbind(dataObjProcessed@reductions$ipca@cell.embeddings[-naInd,1:i],
                                                  dataObjProcessed@reductions$pca@cell.embeddings[-naInd,1:i])
modelResult <- multinom(trueLabel[-naInd] ~ temp, maxit = 1000, MaxNWts = 2000,model = TRUE)
PseudoR2Result=c(PseudoR2Result,PseudoR2(modelResult,c("McFaddenAdj")))
}
names(PseudoR2Result)=1:20
plot(PseudoR2Result,type="b")
max(PseudoR2Result)
#0.7390224
#marker gene expression
selectedGenes=c("DDX54", "TRAF2")
VlnPlot(dataObjProcessed, features = selectedGenes,assay = "SCT")
DotPlot(dataObjProcessed, features = selectedGenes,assay = "SCT")
		
```


# Test SpatialPCA for gene expression data and image feature seperately

```{r, fig.dim = c(12, 4), warning = F, echo = F}

library(SpatialPCA)
library(ggplot2)

SpatialPCAWorkflow <- function(SpatialPCAObj,SpatialPCnum = 30) {
  SpatialPCAObjProcessed <- SpatialPCA_buildKernel(SpatialPCAObj, kerneltype = "gaussian", bandwidthtype = "SJ")
  SpatialPCAObjProcessed <- SpatialPCA_EstimateLoading(SpatialPCAObjProcessed, fast = FALSE, SpatialPCnum = SpatialPCnum)
  SpatialPCAObjProcessed <- SpatialPCA_SpatialPCs(SpatialPCAObjProcessed, fast = FALSE)

  return(SpatialPCAObjProcessed)
  
  #clusterlabel= walktrap_clustering(7, SpatialPCAObjProcessed@SpatialPCs,round(sqrt(dim(SpatialPCAObjProcessed@location)[1])))
  #clusterlabel_refine=refine_cluster_10x(clusterlabel,SpatialPCAObjProcessed@location,shape="square")
  
}

#to SpatialPCA object
makeSpatialPCAObj <- function(dataObjProcessed, 
                              geneResolution=0.8, 
                              imageFeatureResolution=geneResolution, 
                              imageAndGeneResolution=0.8) {
  rawcount <- dataObjProcessed@assays[["Spatial"]]@counts
  location <- as.matrix(dataObjProcessed@images$images@coordinates)
  STGene <- CreateSpatialPCAObject(counts = rawcount, location = location, 
                                   project = dataObjProcessed@project.name, gene.type = "spatial", 
                                   sparkversion = "spark", gene.number = 3000,
                                   customGenelist = NULL, min.loctions = 30, min.features = 30)
  
  imageFeaturesNormlized <- dataObjProcessed@assays[["ImageFeature"]]@data
  STImage <- CreateSpatialPCAObject(counts = imageFeaturesNormlized, location = location, 
                              project = dataObjProcessed@project.name, gene.type="custom",
                              customGenelist = row.names(imageFeaturesNormlized), min.loctions = 30, min.features = 30)
  
  STGeneProcessed <- SpatialPCAWorkflow(STGene)
  STImageProcessed <- SpatialPCAWorkflow(STImage)
  #dataObjProcessed[["pca"]] <- CreateDimReducObject(embeddings = t(STGeneProcessed@SpatialPCs),
  #                                          loadings = STGeneProcessed@W,
  #                                          key = "PC_", assay = DefaultAssay(object))
  
  temp1 <- t(STGeneProcessed@SpatialPCs)
  colnames(temp1) <- paste0("PC",1:ncol(temp1))
  temp2 <- t(STImageProcessed@SpatialPCs)
  colnames(temp2) <- paste0("PC",1:ncol(temp2))

  dataObjProcessedSpatialPCA <- dataObjProcessed
  dataObjProcessedSpatialPCA[["GeneSpatialPCA"]] <- CreateDimReducObject(embeddings = temp1, key = "GeneSpatial_", assay = "Spatial")
  dataObjProcessedSpatialPCA <- FindNeighbors(dataObjProcessedSpatialPCA, reduction = "GeneSpatialPCA", graph.name = c("st_spca_nn", "st_spca_snn"), dims = 1:ncol(temp1))
  dataObjProcessedSpatialPCA <- FindClusters(dataObjProcessedSpatialPCA, verbose = FALSE, graph.name = "st_spca_snn", resolution = geneResolution)
  dataObjProcessedSpatialPCA <- RunUMAP(dataObjProcessedSpatialPCA, reduction = 'GeneSpatialPCA', dims = 1:ncol(temp1), 
                                        assay = "Spatial", reduction.name = 'st.spca.umap', reduction.key = 'stspcaUMAP_')
  dataObjProcessedSpatialPCA[["ImageSpatialPCA"]] <- CreateDimReducObject(embeddings = temp2, key = "ImageSpatial_", assay = "ImageFeature")
  dataObjProcessedSpatialPCA <- FindNeighbors(dataObjProcessedSpatialPCA, reduction = "ImageSpatialPCA", graph.name = c("if_spca_nn", "if_spca_snn"), dims = 1:ncol(temp2))
  dataObjProcessedSpatialPCA <- FindClusters(dataObjProcessedSpatialPCA, verbose = FALSE, graph.name = "if_spca_snn", resolution = imageFeatureResolution)
  dataObjProcessedSpatialPCA <- RunUMAP(dataObjProcessedSpatialPCA, reduction = 'ImageSpatialPCA', dims = 1:ncol(temp2), 
                                        assay = "ImageFeature", reduction.name = 'if.spca.umap', reduction.key = 'ifspcaUMAP_')
  
  dataObjProcessedSpatialPCA <- FindMultiModalNeighbors(
      dataObjProcessedSpatialPCA, reduction.list = list("GeneSpatialPCA", "ImageSpatialPCA"), 
      dims.list = list(1:ncol(temp1), 1:ncol(temp2)),
      knn.graph.name = "spca_wknn", snn.graph.name = "spca_wsnn", weighted.nn.name = "spca.weighted.nn",
      modality.weight.name = c("SCT.spca.weight","ImageFeature.spca.weight"),
      return.intermediate = TRUE)
  dataObjProcessedSpatialPCA <- FindClusters(dataObjProcessedSpatialPCA, graph.name = "spca_wsnn", algorithm = 3, resolution = imageAndGeneResolution, verbose = FALSE)
  dataObjProcessedSpatialPCA <- RunUMAP(dataObjProcessedSpatialPCA, nn.name = "spca.weighted.nn", reduction.name = "spca.wnn.umap", reduction.key = "spcawnnUMAP_")
    
}

geneResolution=1.4
imageFeatureResolution=1.1
imageAndGeneResolution=1

dataObjProcessedSpatialPCA <- makeSpatialPCAObj(dataObjProcessed, geneResolution=1.4, imageFeatureResolution=1.1, imageAndGeneResolution=1)

DefaultAssay(dataObjProcessedSpatialPCA) <- "Spatial"
p9 <- SpatialDimPlot(dataObjProcessedSpatialPCA, group.by = paste0("st_spca_snn_res.", geneResolution), label = TRUE, label.box = F, label.size = 2, pt.size.factor = 10) 
#+ NoLegend()

DefaultAssay(dataObjProcessedSpatialPCA) <- "ImageFeature"
p10 <- SpatialDimPlot(dataObjProcessedSpatialPCA, group.by = paste0("if_spca_snn_res.", imageFeatureResolution), label = TRUE, label.box = F, label.size = 2, pt.size.factor = 10) 
#+ NoLegend()

p11 <- SpatialDimPlot(dataObjProcessedSpatialPCA, group.by= paste0("spca_wsnn_res.", imageAndGeneResolution), label = TRUE, label.box = F, repel = TRUE, label.size = 2, pt.size.factor = 10)
#+ NoLegend()

p9 + p10 + p11


```

```{r, eval = F}
CairoPDF("HER2.H1_SpatialPCA_SpatialDimPlots.pdf", width = 12, height = 6, onefile = T)
p9 + p10 + p11 + plot_layout(ncol = 3)
dev.off()
```


### ARI with pathologist review region for SpatialPCA


```{r, warning = F, echo = T}
temp1=order(dataObjProcessedSpatialPCA@images$images@coordinates$pixel_y,dataObjProcessedSpatialPCA@images$images@coordinates$pixel_x)
#head(positionTable[temp1,])
temp2=order(reviewRegions$y,reviewRegions$x)
#head(reviewRegions[temp2,])
dataObjProcessedSpatialPCA@meta.data$TrueLabel=NA
dataObjProcessedSpatialPCA@meta.data$TrueLabel[temp1]=reviewRegions$label[temp2]

predictedCluster=as.character(dataObjProcessedSpatialPCA@meta.data$"spca_wsnn_res.1")
table(dataObjProcessedSpatialPCA@meta.data$"spca_wsnn_res.1",dataObjProcessedSpatialPCA@meta.data$TrueLabel)
table(predictedCluster,dataObjProcessedSpatialPCA@meta.data$TrueLabel)
predictedCluster[predictedCluster==0]="connective tissue"
predictedCluster[predictedCluster==1]="cancer in situ"
predictedCluster[predictedCluster==2]="invasive cancer"
predictedCluster[predictedCluster==3]="immune infiltrate"
predictedCluster[predictedCluster==4]="adipose tissue"
predictedCluster[predictedCluster==5]="adipose tissue"
predictedCluster[predictedCluster==6]="breast glands"
trueLabel=dataObjProcessedSpatialPCA@meta.data$TrueLabel
naInd=which(trueLabel=="undetermined")
    adjustedRand(
      as.integer(as.factor(predictedCluster[-naInd])),
      as.integer(as.factor(trueLabel[-naInd])),
      randMethod="HA"
    )
#0.65139


```



